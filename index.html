<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text-to-Speech Reader</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: auto;
        }
        #controls {
            margin-top: 10px;
        }
        #controls input, select {
            margin-right: 10px;
            margin-top: 5px;
        }
        #textDisplay {
            margin-top: 20px;
            font-size: 18px;
            color: #333;
        }
        .highlight {
            background-color: yellow;
        }
    </style>
</head>
<body>
    <h2>📢 Text-to-Speech Reader</h2>
    <div id="controls">
        <button onclick="fetchTextAndSpeak()">🔁 Đọc lại</button>
        <button onclick="stopSpeaking()">⏹️ Tạm dừng</button><br><br>

        <label>🎤 Giọng đọc:</label>
        <select id="voiceSelect"></select><br>

        <label>⏩ Tốc độ đọc:</label>
        <input type="number" id="rateInput" value="1" step="0.1" min="0.5" max="2"><br>

        <label>🎚️ Cao độ:</label>
        <input type="number" id="pitchInput" value="1" step="0.1" min="0" max="2"><br>

        <label>🔄 Kiểm tra mỗi (giây):</label>
        <input type="number" id="intervalInput" value="60" min="5" />
        <button onclick="updateIntervalTime()">⏱️ Cập nhật</button>
    </div>

    <div id="textDisplay">Chưa có nội dung nào...</div>
    <p><em>Nói: "đọc lại", "tạm dừng", "tiếp tục" để điều khiển bằng giọng nói</em></p>

    <script>
        let lastSpokenText = '';
        let intervalId;
        let updateInterval = 60000;

        function loadVoices() {
            const voices = speechSynthesis.getVoices();
            const viVoices = voices.filter(voice => voice.lang.startsWith('vi'));
            const select = document.getElementById("voiceSelect");
            select.innerHTML = "";

            if (viVoices.length === 0) {
                alert(`
⚠️ Không tìm thấy giọng đọc tiếng Việt.

👉 Cách khắc phục:
1. Vào cài đặt trình duyệt và thêm ngôn ngữ "Tiếng Việt".
2. Với Chrome: bật "Experimental Web Platform features" tại chrome://flags.
3. Với Android: Cài đặt > Ngôn ngữ & nhập liệu > Văn bản thành giọng nói > tải giọng tiếng Việt.
4. Với macOS: System Settings > Accessibility > Spoken Content > Add Voice.

Sau đó tải lại trang (F5).
                `);
                const option = document.createElement("option");
                option.value = "";
                option.text = "❌ Không có giọng tiếng Việt";
                select.appendChild(option);
                return;
            }

            viVoices.forEach((voice) => {
                const option = document.createElement("option");
                option.value = voice.name;
                option.text = `${voice.name} (${voice.lang})`;
                select.appendChild(option);
            });
        }

        function fetchTextAndSpeak() {
            fetch("https://script.google.com/macros/s/AKfycbz-RacKstruMOWWIkYXNHzX7-ay5Dc4eYxWvRD6D5esvZwxt_jcj7SLCPOdVwAKzqWBNA/exec")  // Thay bằng link Web App của bạn
                .then(res => res.json())
                .then(data => {
                    const displayText = data.displayText;
                    const readText = data.readText;

                    // Hiển thị phần displayText lên giao diện
                    highlightText(displayText, -1);

                    // Nếu có sự thay đổi văn bản cần đọc
                    if (readText && readText !== lastSpokenText) {
                        lastSpokenText = readText;
                        speakText(readText, displayText);
                    }
                })
                .catch(err => {
                    console.error("Lỗi khi gọi API:", err);
                });
        }

        function speakText(text, displayText) {
            if ('speechSynthesis' in window) {
                const sentences = text.split(/[.\n]/).map(s => s.trim()).filter(Boolean);
                const voices = speechSynthesis.getVoices();
                const voice = voices.find(v => v.name === document.getElementById("voiceSelect").value);
                const rate = parseFloat(document.getElementById("rateInput").value);
                const pitch = parseFloat(document.getElementById("pitchInput").value);

                let index = 0;
                function speakNext() {
                    if (index < sentences.length) {
                        const utterance = new SpeechSynthesisUtterance(sentences[index]);
                        utterance.voice = voice;
                        utterance.lang = 'vi-VN';
                        utterance.rate = rate;
                        utterance.pitch = pitch;

                        highlightText(displayText, index);
                        utterance.onend = speakNext;
                        speechSynthesis.speak(utterance);
                        index++;
                    } else {
                        google.script.run.logReadText(text);  // Lưu lịch sử
                    }
                }
                speakNext();
            }
        }

        function highlightText(text, highlightIndex) {
            const textDisplayElement = document.getElementById("textDisplay");
            const sentences = text.split(/[.\n]/).map(s => s.trim()).filter(Boolean);
            let result = "";

            sentences.forEach((sentence, index) => {
                const spanClass = index === highlightIndex ? 'highlight' : '';
                result += `<span class="${spanClass}">${sentence}</span>. <br>`;
            });

            textDisplayElement.innerHTML = result.trim();
        }

        function stopSpeaking() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
        }

        function updateIntervalTime() {
            const newInterval = parseInt(document.getElementById("intervalInput").value);
            if (!isNaN(newInterval) && newInterval >= 5) {
                updateInterval = newInterval * 1000;
                startAutoRead();
            } else {
                alert("Vui lòng nhập số giây hợp lệ (tối thiểu 5 giây)");
            }
        }

        function startAutoRead() {
            clearInterval(intervalId);
            intervalId = setInterval(fetchTextAndSpeak, updateInterval);
        }

        window.onload = () => {
            loadVoices();
            fetchTextAndSpeak();
            startAutoRead();
        };

        window.speechSynthesis.onvoiceschanged = loadVoices;
    </script>
</body>
</html>
