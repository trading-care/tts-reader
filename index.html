<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text-to-Speech Reader</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: auto;
        }
        #controls {
            margin-top: 10px;
        }
        #controls input, select {
            margin-right: 10px;
            margin-top: 5px;
        }
        #textDisplay {
            margin-top: 20px;
            font-size: 18px;
            color: #333;
        }
        .highlight {
            background-color: yellow;
        }
    </style>
</head>
<body>
    <h2>ğŸ“¢ Text-to-Speech Reader</h2>
    <div id="controls">
        <button onclick="fetchTextAndSpeak()">ğŸ” Äá»c láº¡i</button>
        <button onclick="stopSpeaking()">â¹ï¸ Táº¡m dá»«ng</button><br><br>

        <label>ğŸ¤ Giá»ng Ä‘á»c:</label>
        <select id="voiceSelect"></select><br>

        <label>â© Tá»‘c Ä‘á»™ Ä‘á»c:</label>
        <input type="number" id="rateInput" value="1" step="0.1" min="0.5" max="2"><br>

        <label>ğŸšï¸ Cao Ä‘á»™:</label>
        <input type="number" id="pitchInput" value="1" step="0.1" min="0" max="2"><br>

        <label>ğŸ”„ Kiá»ƒm tra má»—i (giÃ¢y):</label>
        <input type="number" id="intervalInput" value="60" min="5" />
        <button onclick="updateIntervalTime()">â±ï¸ Cáº­p nháº­t</button>
    </div>

    <div id="textDisplay">ChÆ°a cÃ³ ná»™i dung nÃ o...</div>
    <p><em>NÃ³i: "Ä‘á»c láº¡i", "táº¡m dá»«ng", "tiáº¿p tá»¥c" Ä‘á»ƒ Ä‘iá»u khiá»ƒn báº±ng giá»ng nÃ³i</em></p>

    <script>
        let lastSpokenText = '';
        let intervalId;
        let updateInterval = 60000;

        function loadVoices() {
            const voices = speechSynthesis.getVoices();
            const viVoices = voices.filter(voice => voice.lang.startsWith('vi'));
            const select = document.getElementById("voiceSelect");
            select.innerHTML = "";

            if (viVoices.length === 0) {
                alert(`
âš ï¸ KhÃ´ng tÃ¬m tháº¥y giá»ng Ä‘á»c tiáº¿ng Viá»‡t.

ğŸ‘‰ CÃ¡ch kháº¯c phá»¥c:
1. VÃ o cÃ i Ä‘áº·t trÃ¬nh duyá»‡t vÃ  thÃªm ngÃ´n ngá»¯ "Tiáº¿ng Viá»‡t".
2. Vá»›i Chrome: báº­t "Experimental Web Platform features" táº¡i chrome://flags.
3. Vá»›i Android: CÃ i Ä‘áº·t > NgÃ´n ngá»¯ & nháº­p liá»‡u > VÄƒn báº£n thÃ nh giá»ng nÃ³i > táº£i giá»ng tiáº¿ng Viá»‡t.
4. Vá»›i macOS: System Settings > Accessibility > Spoken Content > Add Voice.

Sau Ä‘Ã³ táº£i láº¡i trang (F5).
                `);
                const option = document.createElement("option");
                option.value = "";
                option.text = "âŒ KhÃ´ng cÃ³ giá»ng tiáº¿ng Viá»‡t";
                select.appendChild(option);
                return;
            }

            viVoices.forEach((voice) => {
                const option = document.createElement("option");
                option.value = voice.name;
                option.text = `${voice.name} (${voice.lang})`;
                select.appendChild(option);
            });
        }

        function fetchTextAndSpeak() {
            fetch("https://script.google.com/macros/s/AKfycbz-RacKstruMOWWIkYXNHzX7-ay5Dc4eYxWvRD6D5esvZwxt_jcj7SLCPOdVwAKzqWBNA/exec")  // Thay báº±ng link Web App cá»§a báº¡n
                .then(res => res.json())
                .then(data => {
                    const displayText = data.displayText;
                    const readText = data.readText;

                    // Hiá»ƒn thá»‹ pháº§n displayText lÃªn giao diá»‡n
                    highlightText(displayText, -1);

                    // Náº¿u cÃ³ sá»± thay Ä‘á»•i vÄƒn báº£n cáº§n Ä‘á»c
                    if (readText && readText !== lastSpokenText) {
                        lastSpokenText = readText;
                        speakText(readText, displayText);
                    }
                })
                .catch(err => {
                    console.error("Lá»—i khi gá»i API:", err);
                });
        }

        function speakText(text, displayText) {
            if ('speechSynthesis' in window) {
                const sentences = text.split(/[.\n]/).map(s => s.trim()).filter(Boolean);
                const voices = speechSynthesis.getVoices();
                const voice = voices.find(v => v.name === document.getElementById("voiceSelect").value);
                const rate = parseFloat(document.getElementById("rateInput").value);
                const pitch = parseFloat(document.getElementById("pitchInput").value);

                let index = 0;
                function speakNext() {
                    if (index < sentences.length) {
                        const utterance = new SpeechSynthesisUtterance(sentences[index]);
                        utterance.voice = voice;
                        utterance.lang = 'vi-VN';
                        utterance.rate = rate;
                        utterance.pitch = pitch;

                        highlightText(displayText, index);
                        utterance.onend = speakNext;
                        speechSynthesis.speak(utterance);
                        index++;
                    } else {
                        google.script.run.logReadText(text);  // LÆ°u lá»‹ch sá»­
                    }
                }
                speakNext();
            }
        }

        function highlightText(text, highlightIndex) {
            const textDisplayElement = document.getElementById("textDisplay");
            const sentences = text.split(/[.\n]/).map(s => s.trim()).filter(Boolean);
            let result = "";

            sentences.forEach((sentence, index) => {
                const spanClass = index === highlightIndex ? 'highlight' : '';
                result += `<span class="${spanClass}">${sentence}</span>. <br>`;
            });

            textDisplayElement.innerHTML = result.trim();
        }

        function stopSpeaking() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
        }

        function updateIntervalTime() {
            const newInterval = parseInt(document.getElementById("intervalInput").value);
            if (!isNaN(newInterval) && newInterval >= 5) {
                updateInterval = newInterval * 1000;
                startAutoRead();
            } else {
                alert("Vui lÃ²ng nháº­p sá»‘ giÃ¢y há»£p lá»‡ (tá»‘i thiá»ƒu 5 giÃ¢y)");
            }
        }

        function startAutoRead() {
            clearInterval(intervalId);
            intervalId = setInterval(fetchTextAndSpeak, updateInterval);
        }

        window.onload = () => {
            loadVoices();
            fetchTextAndSpeak();
            startAutoRead();
        };

        window.speechSynthesis.onvoiceschanged = loadVoices;
    </script>
</body>
</html>
