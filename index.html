<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0088cc" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />

    <audio id="introAudio" src="https://github.com/trading-care/tts-reader/blob/main/casual-click.mp3?raw=true" preload="auto"></audio>

    <style>
      body { font-family: sans-serif, 'Segoe UI', Tahoma, Geneva, Verdana; padding: 20px; max-width: 600px; margin: auto; }
      
      .logo {
        width: 100px;
        margin-bottom: 20px;
      }

      .button {
        padding: 12px 24px;
        font-size: 1.2em;
        background-color: #0088cc;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 20px;
      }

      .button:hover {
        background-color: #0077b3;
      }

      #controls { margin-top: 10px; }
      #controls input, select { margin-right: 10px; margin-top: 5px; }
      #textDisplay { margin-top: 20px; font-size: 18px; color: #333; }
      .highlight {
        background-color: yellow;
      }
    </style>
    <script>
      let lastSpokenText = '';
      let intervalId;
      let updateInterval = 60000;

      function loadVoices() {
        const voices = speechSynthesis.getVoices();
        const viVoices = voices.filter(voice => voice.lang.startsWith('vi'));
        const select = document.getElementById("voiceSelect");
        select.innerHTML = "";

        if (viVoices.length === 0) {
          alert(`
âš ï¸ KhÃ´ng tÃ¬m tháº¥y giá»ng Ä‘á»c tiáº¿ng Viá»‡t.

ğŸ‘‰ CÃ¡ch kháº¯c phá»¥c:
1. VÃ o cÃ i Ä‘áº·t trÃ¬nh duyá»‡t vÃ  thÃªm ngÃ´n ngá»¯ "Tiáº¿ng Viá»‡t".
2. Vá»›i Chrome: báº­t "Experimental Web Platform features" táº¡i chrome://flags.
3. Vá»›i Android: CÃ i Ä‘áº·t > NgÃ´n ngá»¯ & nháº­p liá»‡u > VÄƒn báº£n thÃ nh giá»ng nÃ³i > táº£i giá»ng tiáº¿ng Viá»‡t.
4. Vá»›i macOS: System Settings > Accessibility > Spoken Content > Add Voice.

Sau Ä‘Ã³ táº£i láº¡i trang (F5).
          `);
          const option = document.createElement("option");
          option.value = "";
          option.text = "âŒ KhÃ´ng cÃ³ giá»ng tiáº¿ng Viá»‡t";
          select.appendChild(option);
          return;
        }

        viVoices.forEach((voice) => {
          const option = document.createElement("option");
          option.value = voice.name;
          option.text = `${voice.name} (${voice.lang})`;
          select.appendChild(option);
        });
      }

      function fetchTextAndSpeak() {
            fetch("https://script.google.com/macros/s/AKfycbwCoM2yQ4P9HnkOtOZjSyIzdGXbO21WeN_fzZgLUu9GvXwVzxuA6Zbl5NlpmmThEhYCJw/exec")  // Thay báº±ng link Web App cá»§a báº¡n
                .then(res => res.json())
                .then(data => {
                    const displayText = data.displayText;
                    const readText = data.readText;

                    // Hiá»ƒn thá»‹ pháº§n displayText lÃªn giao diá»‡n
                    highlightText(displayText, -1);

                    // Náº¿u cÃ³ sá»± thay Ä‘á»•i vÄƒn báº£n cáº§n Ä‘á»c
                    if (readText && readText !== lastSpokenText) {
                        lastSpokenText = readText;
                        speakText(readText, displayText);
                    }
                })
                .catch(err => {
                    console.error("Lá»—i khi gá»i API:", err);
                });
      }

      function speakText(text, displayText) {
        if ('speechSynthesis' in window) {
          const sentences = text.split(/[\n]/).map(s => s.trim()).filter(Boolean);
          const voices = speechSynthesis.getVoices();
          const voice = voices.find(v => v.name === document.getElementById("voiceSelect").value);
          const rate = parseFloat(document.getElementById("rateInput").value);
          const pitch = parseFloat(document.getElementById("pitchInput").value);
          const volume = parseFloat(document.getElementById("volumeInput").value);

          let index = 0;

          function speakNext() {
            if (index < sentences.length) {
              const utterance = new SpeechSynthesisUtterance(sentences[index]);
              utterance.voice = voice;
              utterance.lang = 'vi-VN';
              utterance.rate = rate;
              utterance.pitch = pitch;
              utterance.volume = volume;

              highlightText(displayText, index);
            
              utterance.onend = function () {
                index++;
                speakNext(); // gá»i tiáº¿p sau khi hoÃ n thÃ nh cÃ¢u hiá»‡n táº¡i
              };

              speechSynthesis.speak(utterance);
            } else {
                highlightText(displayText, -1); // âŒ Táº¯t highlight khi Ä‘á»c xong
                google.script.run.logReadText(text); // LÆ°u lá»‹ch sá»­
            }
          }

          speakNext();
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const volumeSlider = document.getElementById("volumeInput");
        const volumeLabel = document.getElementById("volumeValue");
        volumeSlider.addEventListener("input", () => {
          volumeLabel.textContent = volumeSlider.value;
        });
      });

      function highlightText(text, highlightIndex) {
        const textDisplayElement = document.getElementById("textDisplay");
        const sentences = text.split(/[\n]/).map(s => s.trim()).filter(Boolean);
        let result = "";

        sentences.forEach((sentence, index) => {
          if (index === highlightIndex) {
            result += `<div><span class="highlight">${sentence}</span></div>`;
          } else {
            result += `<div>${sentence}</div>`;
          }
        });

        textDisplayElement.innerHTML = result.trim();
      }

      function stopSpeaking() {
        if ('speechSynthesis' in window) {
          speechSynthesis.cancel();
        }
      }

      function startAutoRead() {
        clearInterval(intervalId);
        intervalId = setInterval(fetchTextAndSpeak, updateInterval);
      }

      function updateIntervalTime() {
        const newInterval = parseInt(document.getElementById("intervalInput").value);
        if (!isNaN(newInterval) && newInterval >= 5) {
          updateInterval = newInterval * 1000;
          startAutoRead();
        } else {
          alert("Vui lÃ²ng nháº­p sá»‘ giÃ¢y há»£p lá»‡ (tá»‘i thiá»ƒu 5 giÃ¢y)");
        }
      }

      function setupVoiceControl() {
        if (!('webkitSpeechRecognition' in window)) {
          alert("âš ï¸ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ voice command.");
          return;
        }

        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'vi-VN';
        recognition.continuous = true;
        recognition.interimResults = false;

        recognition.onresult = function(event) {
          const command = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
          console.log("Lá»‡nh giá»ng nÃ³i:", command);
          if (command.includes("Ä‘á»c láº¡i")) fetchTextAndSpeak();
          else if (command.includes("táº¡m dá»«ng")) stopSpeaking();
          else if (command.includes("tiáº¿p tá»¥c")) fetchTextAndSpeak();
          else if (command.includes("tÄƒng Ã¢m lÆ°á»£ng")) changeVolume(0.1);
          else if (command.includes("giáº£m Ã¢m lÆ°á»£ng")) changeVolume(-0.1);
        };

        recognition.onerror = function(event) {
          console.error("Voice recognition error:", event.error);
          if (event.error === 'not-allowed') {
            alert("âŒ TrÃ¬nh duyá»‡t Ä‘Ã£ cháº·n quyá»n sá»­ dá»¥ng microphone.\n\nğŸ‘‰ HÃ£y kiá»ƒm tra quyá»n microphone trong trÃ¬nh duyá»‡t vÃ  báº­t láº¡i.");
          }
        };

        recognition.start();
      }

      function changeVolume(step) {
        const volumeSlider = document.getElementById("volumeInput");
        let volume = parseFloat(volumeSlider.value);
        volume = Math.min(1, Math.max(0, volume + step));
        volumeSlider.value = volume.toFixed(1);
        document.getElementById("volumeValue").textContent = volume.toFixed(1);
      }

      // KÃ­ch hoáº¡t audio náº¿u bá»‹ cháº·n bá»Ÿi autoplay policy
      function tryPlayAudio() {
        const audio = document.getElementById("introAudio");

        // Cho phÃ©p phÃ¡t audio trÃªn thiáº¿t bá»‹ cáº£m á»©ng (iOS/Android)
        document.addEventListener("touchstart", () => {
          audio.play().catch(err => {
            console.log("Autoplay bá»‹ cháº·n sau touchstart:", err);
          });
        }, { once: true });

        // Cho phÃ©p phÃ¡t audio trÃªn desktop (click)
        document.addEventListener("click", () => {
          if (audio.paused) {
            audio.play().catch(err => {
              console.log("Autoplay bá»‹ cháº·n sau click:", err);
            });
          }
        }, { once: true });

        // Thá»­ phÃ¡t ngay láº­p tá»©c
        audio.play().catch(() => {
          console.log("Autoplay bá»‹ cháº·n. Chá» tÆ°Æ¡ng tÃ¡c tá»« ngÆ°á»i dÃ¹ng...");
        });
      }

      // Gá»i thá»­ phÃ¡t audio khi load xong
      window.addEventListener("DOMContentLoaded", tryPlayAudio);

      function startReading() {
        const audio = document.getElementById("introAudio");
        if (audio.paused) {
          audio.play().catch(err => console.log("KhÃ´ng thá»ƒ phÃ¡t intro:", err));
        }
        // Chuyá»ƒn Ä‘áº¿n app chÃ­nh (cÃ³ thá»ƒ Ä‘á»•i Ä‘Æ°á»ng dáº«n tuá»³ Ã½)
        //window.location.href = "index.html";
        
        fetchTextAndSpeak();
        startAutoRead();
      }

      window.onload = () => {
        loadVoices();
        // fetchTextAndSpeak();
        // startAutoRead();
        setupVoiceControl();
      };

      window.speechSynthesis.onvoiceschanged = loadVoices;
    </script>
  </head>

  <body>
    <h2></h2>
    <div id="controls">
      <img src="https://github.com/trading-care/tts-reader/blob/main/icons/icon-192.png?raw=true" alt="App Logo" class="logo"/>
      <h1>Text Reader!</h1>
      <p>Nháº¥n vÃ o nÃºt ğŸ“¢ Báº¯t Ä‘áº§u Ä‘á»ƒ Ä‘á»c.</p>
      <button onclick="startReading()">ğŸ“¢ Báº¯t Ä‘áº§u</button>
      <button onclick="fetchTextAndSpeak()">ğŸ” Äá»c láº¡i</button>
      <button onclick="stopSpeaking()">â¹ï¸ Táº¡m dá»«ng</button><br><br>

      <label>ğŸ¤ Giá»ng Ä‘á»c:</label>
      <select id="voiceSelect"></select><br>

      <label>â© Tá»‘c Ä‘á»™ Ä‘á»c:</label>
      <input type="number" id="rateInput" value="1" step="0.1" min="0.5" max="2" style="width: 30px;"><br>

      <label>ğŸšï¸ Cao Ä‘á»™:</label>
      <input type="number" id="pitchInput" value="1" step="0.1" min="0" max="2" style="width: 30px;"><br>

      <label>ğŸ”Š Ã‚m lÆ°á»£ng:</label>
      <button onclick="changeVolume(-0.1)">ğŸ”‰</button>
      <input type="range" id="volumeInput" min="0" max="1" step="0.1" value="0.7">
      <button onclick="changeVolume(0.1)">ğŸ”Š</button>
      <span id="volumeValue">0.7</span><br><br>

      <label>ğŸ”„ Kiá»ƒm tra dá»¯ liá»‡u má»›i sau:</label>
      <input type="number" id="intervalInput" value="60" min="5" style="width: 30px;"/>
      <span>(giÃ¢y)</span>
      <button onclick="updateIntervalTime()">  â±ï¸ Cáº­p nháº­t</button>
    </div>

    <div id="textDisplay">ChÆ°a cÃ³ ná»™i dung Ä‘á»ƒ Ä‘á»c...</div><br><br>
    <p>HÃ£y nÃ³i: <em><b>'Ä‘á»c láº¡i', 'táº¡m dá»«ng', 'tiáº¿p tá»¥c', 'tÄƒng Ã¢m lÆ°á»£ng', 'giáº£m Ã¢m lÆ°á»£ng'</b></em> Ä‘á»ƒ Ä‘iá»u khiá»ƒn báº±ng giá»ng nÃ³i!</p>
  </body>
</html>